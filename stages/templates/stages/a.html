# models.py
from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone

class Departement(models.Model):
    nom = models.CharField(max_length=100)

    def __str__(self):
        return self.nom

class Annonce(models.Model):
    titre = models.CharField(max_length=255)
    contenu = models.TextField()
    date_publication = models.DateTimeField(auto_now_add=True)
    departement = models.ForeignKey(Departement, on_delete=models.CASCADE, related_name='annonces')
    auteur = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    fichier = models.FileField(upload_to='annonces_fichiers/', blank=True, null=True)

    def __str__(self):
        return f"{self.titre} ({self.departement.nom})"

class Etudiant(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    nom_complet = models.CharField(max_length=100)
    departement = models.ForeignKey(Departement, on_delete=models.SET_NULL, null=True)
    last_annonce_vue = models.DateTimeField(default=timezone.now)
    # autres champs...

    def __str__(self):
        return self.nom_complet


# views.py
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.utils import timezone
from django.http import HttpResponseForbidden
from .models import Annonce, Etudiant

@login_required
def ajouter_annonce(request):
    if not hasattr(request.user, 'departement_chef'):
        return HttpResponseForbidden("Seuls les chefs de d√©partement peuvent publier des annonces.")

    if request.method == 'POST':
        titre = request.POST['titre']
        contenu = request.POST['contenu']
        fichier = request.FILES.get('fichier')
        Annonce.objects.create(
            titre=titre,
            contenu=contenu,
            fichier=fichier,
            departement=request.user.departement_chef,
            auteur=request.user
        )
        return redirect('liste_annonces')

    return render(request, 'messaging/ajouter_annonce.html')

@login_required
def annonces_etudiant(request):
    etudiant = Etudiant.objects.get(user=request.user)
    annonces = Annonce.objects.filter(departement=etudiant.departement).order_by('-date_publication')
    etudiant.last_annonce_vue = timezone.now()
    etudiant.save()
    return render(request, 'messaging/annonces_etudiant.html', {'annonces': annonces})

@login_required
def dashboard_etudiant(request):
    etudiant = Etudiant.objects.get(user=request.user)
    nouvelles_annonces = Annonce.objects.filter(
        departement=etudiant.departement,
        date_publication__gt=etudiant.last_annonce_vue
    ).count()
    return render(request, 'etudiant/dashboard.html', {'nouvelles_annonces': nouvelles_annonces})


# urls.py
from django.urls import path
from . import views

urlpatterns = [
    path('annonce/ajouter/', views.ajouter_annonce, name='ajouter_annonce'),
    path('annonces/', views.annonces_etudiant, name='liste_annonces'),
]


<!-- ajouter_annonce.html -->
{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>Publier une annonce</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="titre" class="form-label">Titre</label>
                    <input type="text" class="form-control" name="titre" required>
                </div>
                <div class="mb-3">
                    <label for="contenu" class="form-label">Contenu</label>
                    <textarea class="form-control" name="contenu" rows="5" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="fichier" class="form-label">Fichier joint</label>
                    <input type="file" class="form-control" name="fichier">
                </div>
                <button type="submit" class="btn btn-primary">Publier</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}


<!-- annonces_etudiant.html -->
{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <h4>Annonces de votre d√©partement</h4>
    {% for annonce in annonces %}
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">{{ annonce.titre }}</div>
        <div class="card-body">
            <p>{{ annonce.contenu }}</p>
            <small class="text-muted">Publi√© {{ annonce.date_publication|timesince }} ago</small>
            {% if annonce.fichier %}
                <br><a href="{{ annonce.fichier.url }}" class="btn btn-sm btn-outline-dark mt-2" download>üìé T√©l√©charger le fichier joint</a>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <p>Aucune annonce disponible.</p>
    {% endfor %}
</div>
{% endblock %}


<!-- Exemple dans base.html pour notification -->
<a href="{% url 'liste_annonces' %}" class="nav-link">
    Annonces
    {% if nouvelles_annonces > 0 %}
    <span class="badge bg-danger">{{ nouvelles_annonces }}</span>
    {% endif %}
</a>
